unit Main;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, System.Win.ScktComp, Vcl.StdCtrls,
  Vcl.Buttons, Vcl.ComCtrls, Vcl.ExtCtrls;

type
  TUMain = class(TForm)
    Edt_Host: TEdit;
    Label1: TLabel;
    Btn_Start: TBitBtn;
    Edt_Port: TEdit;
    Label2: TLabel;
    Client_Sock: TClientSocket;
    StatusBar_APP: TStatusBar;
    TAuto_Reconn: TTimer;
    Auto_Reconn_Chek: TCheckBox;
    procedure Btn_StartClick(Sender: TObject);
    procedure Client_SockConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure Client_SockDisconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure Client_SockRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure Client_SockError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure Client_SockConnecting(Sender: TObject; Socket: TCustomWinSocket);
    procedure FormDestroy(Sender: TObject);
    procedure TAuto_ReconnTimer(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  UMain: TUMain;

implementation

uses
  CMD_Dialect;

{$R *.dfm}

procedure TUMain.Btn_StartClick(Sender: TObject);
begin
 with Btn_Start do
  begin
    case Tag of
      0: begin
           Client_Sock.Port   := StrToInt(Edt_Port.Text);
           Client_Sock.Host   := (Edt_Host.Text);
           Client_Sock.Active := True;
           Caption := 'Stop Client !';
           Tag := 1;
           Edt_Port.Enabled:= False;
           Edt_Host.Enabled:= False;
      end;
      1: begin
           Client_Sock.Active := False;
           Caption := 'Start Client';
           Tag := 0;
           Edt_Port.Enabled:= True;
           Edt_Host.Enabled:= True;
      end;
    end;
  end;
//=============
 if Auto_Reconn_Chek.Checked then
   TAuto_Reconn.Enabled := True
 else
   TAuto_Reconn.Enabled := False;
end;

procedure TUMain.Client_SockConnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  StatusBar_APP.Panels.Items[1].Text := 'Client is Activated ,Connections on the IP: ' +Socket.RemoteAddress ;
  Btn_Start.Enabled:= True;
end;

procedure TUMain.Client_SockConnecting(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  StatusBar_APP.Panels.Items[1].Text := 'Connecting...';
  Btn_Start.Enabled:= False;
end;

procedure TUMain.Client_SockDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  StatusBar_APP.Panels.Items[1].Text := 'Client is Stopped';
//==========
  Btn_Start.Caption := 'Start Client';
  Edt_Port.Enabled:= True;
  Edt_Host.Enabled:= True;
  Btn_Start.Tag := 0;
end;

procedure TUMain.Client_SockError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ErrorCode := 0;
  StatusBar_APP.Panels.Items[1].Text := 'Connection Error !!';
//==========
  Btn_Start.Enabled:= True;
  Btn_Start.Caption := 'Start Client';
  Edt_Port.Enabled:= True;
  Edt_Host.Enabled:= True;
  Btn_Start.Tag := 0;
end;

procedure TUMain.Client_SockRead(Sender: TObject; Socket: TCustomWinSocket);
var  StrCommand : string;
begin
  StrCommand := string(Socket.ReceiveText);
//=======
  if StrCommand = '22' then
  begin
    Client_Sock.Active := False;
  end;

end;

procedure TUMain.FormDestroy(Sender: TObject);
begin
  Client_Sock.Active := False;
end;

procedure TUMain.TAuto_ReconnTimer(Sender: TObject);
begin
 if not Client_Sock.Active then
    Client_Sock.Active := True;
end;

end.
